<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Step-by-step walk-through of the process of adapting &lt;a href='https://twitter.com/LeeSharpeNFL' target='blank'&gt;Lee Sharpe's&lt;/a&gt; win probability charts to college football using data from &lt;a href='https://www.collegefootballdata.com' target='blank'&gt;CollegeFootballData.com&lt;/a&gt; collected using the &lt;code&gt;cfbfastR&lt;/code&gt; package for R.">
<title>Making Animated Win Probability Charts with cfbfastR • cfbfastR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Making Animated Win Probability Charts with cfbfastR">
<meta property="og:description" content="Step-by-step walk-through of the process of adapting &lt;a href='https://twitter.com/LeeSharpeNFL' target='blank'&gt;Lee Sharpe's&lt;/a&gt; win probability charts to college football using data from &lt;a href='https://www.collegefootballdata.com' target='blank'&gt;CollegeFootballData.com&lt;/a&gt; collected using the &lt;code&gt;cfbfastR&lt;/code&gt; package for R.">
<meta property="og:image" content="https://github.com/sportsdataverse/cfbfastR-data/blob/main/themes/social_card_cfbfastR_final_quote.png?raw=true">
<meta property="og:image:alt" content="When you code good, you know good. When you know good, you win good. When you win good, they pay good.">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@JaredDLee">
<meta name="twitter:site" content="@cfbfastR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script defer data-domain="cfbfastr.sportsdataverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">cfbfastR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.9.5</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown--funcs">
    <span class="fas fa fas fa-code"></span>
     
    Funcs
  </a>
  <div class="dropdown-menu" aria-labelledby="dropdown--funcs">
    <a class="dropdown-item" href="../reference/index.html">Function Index</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>cfbfastR Data</h6>
    <a class="dropdown-item" href="../reference/load_cfb_pbp.html">Load Full Season PBP Data</a>
    <a class="dropdown-item" href="../reference/update_cfb_db.html">Update or Create Database</a>
    <a class="dropdown-item" href="../reference/cfbd_pbp_data.html">Play-by-Play Data</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>CFB Data</h6>
    <a class="dropdown-item" href="../reference/register_cfbd.html">CFBD API Keys</a>
    <a class="dropdown-item" href="../reference/cfbd_games.html">Games</a>
    <a class="dropdown-item" href="../reference/cfbd_play.html">Plays</a>
    <a class="dropdown-item" href="../reference/cfbd_drives.html">Drives</a>
    <a class="dropdown-item" href="../reference/cfbd_teams.html">Teams</a>
    <a class="dropdown-item" href="../reference/cfbd_players.html">Players</a>
    <a class="dropdown-item" href="../reference/cfbd_stats.html">Statistics</a>
    <a class="dropdown-item" href="../reference/cfbd_metrics.html">Metrics</a>
    <a class="dropdown-item" href="../reference/cfbd_ratings.html">Ratings</a>
    <a class="dropdown-item" href="../reference/cfbd_draft.html">Draft</a>
    <a class="dropdown-item" href="../reference/cfbd_betting_lines.html">Betting</a>
    <a class="dropdown-item" href="../reference/cfbd_recruiting.html">Recruiting</a>
    <a class="dropdown-item" href="../reference/cfbd_coaches.html">Coaches</a>
    <a class="dropdown-item" href="../reference/cfbd_conferences.html">Conferences</a>
    <a class="dropdown-item" href="../reference/cfbd_venues.html">Venues</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>ESPN Data</h6>
    <a class="dropdown-item" href="../reference/espn_metrics.html">ESPN Metrics</a>
    <a class="dropdown-item" href="../reference/espn_ratings_fpi.html">ESPN Ratings</a>
    <a class="dropdown-item" href="../reference/espn_cfb_scoreboard.html">ESPN Scoreboard</a>
    <a class="dropdown-item" href="../reference/espn_cfb_pbp.html">ESPN PBP</a>
  </div>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown--articles">
    <span class="fas fa fas fa-book-reader"></span>
     
    Articles
  </a>
  <div class="dropdown-menu" aria-labelledby="dropdown--articles">
    <a class="dropdown-item" href="../articles/index.html">Vignettes</a>
    <h6 class="dropdown-header" data-toc-skip>Introductory</h6>
    <a class="dropdown-item" href="../articles/intro.html">CFB Analytics with cfbfastR</a>
    <a class="dropdown-item" href="../articles/animated-wp-plotting.html">Animated Win Probability Plots</a>
    <a class="dropdown-item" href="../articles/fourth-down-plot-tutorial.html">Fourth Down Tendency Plots</a>
    <a class="dropdown-item" href="../articles/rolling-epa-graph.html">Rolling EPA Graphs</a>
    <a class="dropdown-item" href="../articles/nth-rated-recruit.html">Visualizing Team Talent with Player Recruit Rankings</a>
    <a class="dropdown-item" href="../articles/map-tutorial.html">Intro to Visualizing Recruiting Geography</a>
    <h6 class="dropdown-header" data-toc-skip>Expected Points Model Fundamentals</h6>
    <a class="dropdown-item" href="../articles/college-football-expected-points-model-fundamentals-part-i.html">Part 1 - Model Definition</a>
    <a class="dropdown-item" href="../articles/college-football-expected-points-model-fundamentals-part-ii.html">Part 2 - Regression Models</a>
    <a class="dropdown-item" href="../articles/college-football-expected-points-model-fundamentals-part-iii.html">Part 3 - History of Expected Points Models</a>
    <h6 class="dropdown-header" data-toc-skip>CFBD Tutorials</h6>
    <a class="dropdown-item" href="../articles/cfbd_betting.html">CFBD Betting</a>
    <a class="dropdown-item" href="../articles/cfbd_games.html">CFBD Games</a>
    <a class="dropdown-item" href="../articles/cfbd_plays.html">CFBD Plays</a>
    <a class="dropdown-item" href="../articles/cfbd_recruiting.html">CFBD Recruiting</a>
    <a class="dropdown-item" href="../articles/cfbd_stats.html">CFBD Stats</a>
    <a class="dropdown-item" href="../articles/cfbd_teams.html">CFBD Teams</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">
    <span class="fas fa fas fa-newspaper"></span>
     
     News
  </a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown--sdv">
    <span class="fas fa fas fa-project-diagram"></span>
     
     SDV
  </a>
  <div class="dropdown-menu" aria-labelledby="dropdown--sdv">
    <a class="external-link dropdown-item" href="https://sportsdataverse.org/">SportsDataverse</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>R Packages</h6>
    <a class="external-link dropdown-item" href="https://r.sportsdataverse.org/">sportsdataverse-R</a>
    <a class="dropdown-item" href="https://cfbfastR.sportsdataverse.org/">cfbfastR</a>
    <a class="external-link dropdown-item" href="https://hoopR.sportsdataverse.org/">hoopR</a>
    <a class="external-link dropdown-item" href="https://wehoop.sportsdataverse.org/">wehoop</a>
    <a class="external-link dropdown-item" href="https://fastRhockey.sportsdataverse.org/">fastRhockey</a>
    <a class="external-link dropdown-item" href="https://hockeyr.netlify.app/">hockeyR</a>
    <a class="external-link dropdown-item" href="https://abhiamishra.github.io/ggshakeR/">ggshakeR</a>
    <a class="external-link dropdown-item" href="https://BillPetti.github.io/baseballr/">baseballr</a>
    <a class="external-link dropdown-item" href="https://jaseziv.github.io/worldfootballR/">worldfootballR</a>
    <a class="external-link dropdown-item" href="https://usfootballR.sportsdataverse.org/">usfootballR</a>
    <a class="external-link dropdown-item" href="https://github.com/Dato-Futbol/soccerAnimate/">soccerAnimate</a>
    <a class="external-link dropdown-item" href="https://jaseziv.github.io/chessR/">chessR</a>
    <a class="external-link dropdown-item" href="https://oddsapiR.sportsdataverse.org/">oddsapiR</a>
    <a class="external-link dropdown-item" href="https://sportyR.sportsdataverse.org/">sportyR</a>
    <a class="external-link dropdown-item" href="https://torvik.dev/">toRvik</a>
    <a class="external-link dropdown-item" href="https://cfbplotR.sportsdataverse.org/">cfbplotR</a>
    <a class="external-link dropdown-item" href="https://camdenk.github.io/mlbplotR/">mlbplotR</a>
    <a class="external-link dropdown-item" href="https://github.com/sportsdataverse/softballR/">softballR</a>
    <a class="external-link dropdown-item" href="https://cfb4th.sportsdataverse.org/">cfb4th</a>
    <a class="external-link dropdown-item" href="https://github.com/nwslR/nwslR/">nwslR</a>
    <a class="external-link dropdown-item" href="https://jacklich10.github.io/gamezoneR/">gamezoneR</a>
    <a class="external-link dropdown-item" href="https://recruitr.sportsdataverse.org/">recruitR</a>
    <a class="external-link dropdown-item" href="https://puntalytics.github.io/puntr/">puntr</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Python Packages</h6>
    <a class="external-link dropdown-item" href="https://py.sportsdataverse.org/">sportsdataverse-py</a>
    <a class="external-link dropdown-item" href="https://sportypy.sportsdataverse.org/">sportypy</a>
    <a class="external-link dropdown-item" href="https://github.com/nwslR/nwslpy/">nwslpy</a>
    <a class="external-link dropdown-item" href="https://github.com/sportsdataverse/recruitR-py/">recruitR-py</a>
    <a class="external-link dropdown-item" href="https://github.com/nathanblumenfeld/collegebaseball/">collegebaseball</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Node.js Packages</h6>
    <a class="external-link dropdown-item" href="https://js.sportsdataverse.org/">sportsdataverse.js</a>
    <a class="external-link dropdown-item" href="https://github.com/nntrn/nfl-nerd/">nfl-nerd</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown--data">
    <span class="fas fa fas fa-database"></span>
     
     Data
  </a>
  <div class="dropdown-menu" aria-labelledby="dropdown--data">
    <a class="external-link dropdown-item" href="https://collegefootballdata.com">CFBData.com</a>
    <a class="external-link dropdown-item" href="https://github.com/sportsdataverse/sportsdataverse-data/releases">SDV Data Releases</a>
    <a class="external-link dropdown-item" href="https://github.com/sportsdataverse/cfbfastR-data">Data Repository</a>
    <a class="external-link dropdown-item" href="https://github.com/sportsdataverse/cfbfastR-raw">Raw Data Repository</a>
  </div>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="http://gameonpaper.com/cfb">
    <span class="fas fa fas fa-football-ball"></span>
     
     GP
  </a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="http://twitter.com/cfbfastR">
    <span class="fab fa fab fa-twitter fa-lg"></span>
     
  </a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/sportsdataverse/cfbfastR/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Making Animated Win Probability Charts with cfbfastR</h1>
                        <h4 data-toc-skip class="author">Jared Lee
<br><a href="https://twitter.com/JaredDLee" target="blank" class="external-link"><img src="https://img.shields.io/twitter/follow/JaredDLee?color=blue&amp;label=%40JaredDLee&amp;logo=twitter&amp;style=for-the-badge" alt="@JaredDLee"></a>
<a href="https://github.com/Kazink36" target="blank" class="external-link"><img src="https://img.shields.io/github/followers/Kazink36?color=eee&amp;logo=Github&amp;style=for-the-badge" alt="@Kazink36"></a>
</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/sportsdataverse/cfbfastR/blob/HEAD/vignettes/animated-wp-plotting.Rmd" class="external-link"><code>vignettes/animated-wp-plotting.Rmd</code></a></small>
      <div class="d-none name"><code>animated-wp-plotting.Rmd</code></div>
    </div>

    
    
<p>Have you ever wanted to make an <a href="https://kazink36.github.io/images/animated_wp_ex_wide.gif" class="external-link">animated
win probability chart</a> for college football like <a href="https://twitter.com/LeeSharpeNFL" class="external-link">Lee Sharpe</a> makes for <a href="https://twitter.com/LeeSharpeNFL/status/1300526539344289792" class="external-link">the
NFL</a>? This document will walk you step-by-step through the process of
adapting <a href="https://github.com/leesharpe/nfldata/blob/master/code/wpchart.R" class="external-link">Sharpe’s
code</a> to college football using data from <a href="collegefootballdata.com">CollegeFootballData.com</a> collected
using the <code>cfbfastR</code> package for R.</p>
<p>-<a href="https://twitter.com/JaredDLee" class="external-link">Jared Lee</a></p>
<div class="section level2">
<h2 id="load-and-install-packages">Load and Install Packages<a class="anchor" aria-label="anchor" href="#load-and-install-packages"></a>
</h2>
<p>We’re going to need several packages to generate the winning
percentage plot: <code>tidyverse</code> for easy data wrangling, string
manipulation, and plotting, <code>glue</code> to easily make the labels,
<code>ggimage</code> to put the logos on the plot, and
<code>animation</code> to actually build the GIF.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">'pacman'</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">'pacman'</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html" class="external-link">p_load</a></span><span class="op">(</span><span class="va">tidyverse</span>, <span class="va">animation</span>, <span class="va">glue</span>, <span class="va">zoo</span>, <span class="va">ggimage</span>, <span class="va">cfbfastR</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="cfbfastr">cfbfastR<a class="anchor" aria-label="anchor" href="#cfbfastr"></a>
</h2>
<p>We’ll start by picking a team, a week, and a year and using
<code>cfbfastR</code>’s functions to pull the play-by-play and the game
info. <code><a href="../reference/cfbd_pbp_data.html">cfbd_pbp_data()</a></code> will grab the play-by-play info and
make sure that epa_wpa is TRUE to get the win probabilities for the
plot. <code><a href="../reference/cfbd_game_info.html">cfbd_game_info()</a></code> will pull the game info such as the
home and away team and the result.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">team</span> <span class="op">&lt;-</span> <span class="st">"Utah"</span></span>
<span><span class="va">week</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">year</span> <span class="op">&lt;-</span> <span class="fl">2019</span></span>
<span></span>
<span><span class="va">interp_TimeSecsRem</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pbp</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">pbp</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">mutate</span><span class="op">(</span>TimeSecsRem <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">TimeSecsRem</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">TimeSecsRem</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="va">TimeSecsRem</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="va">TimeSecsRem</span><span class="op">)</span></span>
<span>  <span class="va">ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">temp</span><span class="op">$</span><span class="va">TimeSecsRem</span> <span class="op">==</span> <span class="fl">1800</span><span class="op">)</span></span>
<span>  <span class="va">temp</span><span class="op">$</span><span class="va">TimeSecsRem</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1800</span></span>
<span>  <span class="va">temp</span><span class="op">$</span><span class="va">TimeSecsRem</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">temp</span><span class="op">$</span><span class="va">TimeSecsRem</span><span class="op">[</span><span class="va">ind</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">pbp</span><span class="op">&lt;-</span> <span class="va">pbp</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">mutate</span><span class="op">(</span>TimeSecsRem <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu">zoo</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/zoo/man/na.approx.html" class="external-link">na.approx</a></span><span class="op">(</span><span class="va">temp</span><span class="op">$</span><span class="va">TimeSecsRem</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">mutate</span><span class="op">(</span>clock.minutes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">TimeSecsRem</span><span class="op">/</span><span class="fl">60</span><span class="op">)</span>,clock.seconds <span class="op">=</span> <span class="va">TimeSecsRem</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="fl">60</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">pbp</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">game_pbp</span> <span class="op">&lt;-</span> <span class="fu">cfbfastR</span><span class="fu">::</span><span class="fu"><a href="../reference/cfbd_pbp_data.html">cfbd_pbp_data</a></span><span class="op">(</span><span class="va">year</span>, team <span class="op">=</span> <span class="va">team</span>, week <span class="op">=</span> <span class="va">week</span>, epa_wpa <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">down</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">interp_TimeSecsRem</span><span class="op">(</span><span class="op">)</span> </span>
<span>  </span>
<span><span class="va">game</span> <span class="op">&lt;-</span> <span class="fu">cfbfastR</span><span class="fu">::</span><span class="fu"><a href="../reference/cfbd_game_info.html">cfbd_game_info</a></span><span class="op">(</span>year<span class="op">=</span><span class="va">year</span>, team <span class="op">=</span> <span class="va">team</span>, week <span class="op">=</span> <span class="va">week</span><span class="op">)</span></span></code></pre></div>
<p>We’ll also use the <code><a href="../reference/cfbd_team_info.html">cfbd_team_info()</a></code> function to pull the
color and logo information and add it to the game info. We’ll also add
in a <code>result</code> column that is the score difference between the
home and the away teams that we’ll use later.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">team_info</span> <span class="op">&lt;-</span> <span class="fu">cfbfastR</span><span class="fu">::</span><span class="fu"><a href="../reference/cfbd_team_info.html">cfbd_team_info</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">team_logos</span> <span class="op">&lt;-</span> <span class="va">team_info</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">school</span>, <span class="va">color</span>, <span class="va">alt_color</span>, <span class="va">logo</span>, <span class="va">alt_name2</span><span class="op">)</span></span>
<span><span class="va">game</span> <span class="op">&lt;-</span> <span class="va">game</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">team_logos</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"away_team"</span> <span class="op">=</span> <span class="st">"school"</span><span class="op">)</span>,<span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">rename</span><span class="op">(</span>away_logo <span class="op">=</span> <span class="va">logo</span>, away_color <span class="op">=</span> <span class="va">color</span>, away_alt_color <span class="op">=</span> <span class="va">alt_color</span>, away_abr <span class="op">=</span> <span class="va">alt_name2</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">game</span> <span class="op">&lt;-</span> <span class="va">game</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">team_logos</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"home_team"</span> <span class="op">=</span> <span class="st">"school"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">rename</span><span class="op">(</span>home_logo <span class="op">=</span> <span class="va">logo</span>, home_color <span class="op">=</span> <span class="va">color</span>, home_alt_color <span class="op">=</span> <span class="va">alt_color</span>, home_abr <span class="op">=</span> <span class="va">alt_name2</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>result <span class="op">=</span> <span class="va">home_points</span> <span class="op">-</span> <span class="va">away_points</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">rename</span><span class="op">(</span>home_score <span class="op">=</span> <span class="va">home_points</span>, away_score <span class="op">=</span> <span class="va">away_points</span><span class="op">)</span></span></code></pre></div>
<p>To build the labels, we’re going to use a custom function to pull the
player names out of the play text. <a href="https://twitter.com/SaiemGilani" class="external-link">Saiem Gilani</a> wrote the bulk
of the regular expressions here to get the names. EDIT: The improved
version of this is now included in the <code><a href="../reference/cfbd_pbp_data.html">cfbd_pbp_data()</a></code>
function by default.</p>
<p>Now we are ready to transform our play-by-play data frame to match
what we need to work with Lee Sharpe’s animation code. First, we will
rename several columns that are similar between <code>cfbfastR</code>
and <code>nflfastR</code> to match <code>nflfastR</code>’s column names.
Then we need to create a few new columns that <code>cfbfastR</code>
doesn’t have. <code>game_seconds_remaining</code> is really just
renaming <code>TimeSecsRem</code> but correcting for the half.
<code>result</code> grabs from the game information and is the
difference in the home and away score. We create the <code>time</code>
column to use as the clock on the right side of the animation.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">game_pbp</span> <span class="op">&lt;-</span> <span class="va">game_pbp</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">rename</span><span class="op">(</span>qtr <span class="op">=</span> <span class="va">period</span>, wp <span class="op">=</span> <span class="va">wp_before</span>, posteam <span class="op">=</span> <span class="va">pos_team</span>, defteam <span class="op">=</span> <span class="va">def_pos_team</span>,</span>
<span>         away_team <span class="op">=</span> <span class="va">away</span>, home_team <span class="op">=</span> <span class="va">home</span>, play_id <span class="op">=</span> <span class="va">game_play_number</span>,</span>
<span>         posteam_score <span class="op">=</span> <span class="va">pos_team_score</span>, defteam_score <span class="op">=</span> <span class="va">def_pos_team_score</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>game_seconds_remaining <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">half</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">TimeSecsRem</span> <span class="op">+</span> <span class="fl">1800</span>, <span class="va">TimeSecsRem</span><span class="op">)</span>,</span>
<span>         result <span class="op">=</span> <span class="va">game</span><span class="op">$</span><span class="va">result</span>,</span>
<span>         minlabel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">clock.minutes</span> <span class="op">&gt;=</span> <span class="fl">15</span>,</span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">clock.minutes</span> <span class="op">==</span> <span class="fl">15</span> <span class="op">&amp;</span> <span class="va">clock.seconds</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">15</span>, <span class="va">clock.minutes</span> <span class="op">-</span> <span class="fl">15</span><span class="op">)</span>,</span>
<span>                           <span class="va">clock.minutes</span><span class="op">)</span>,</span>
<span>         minlabel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">minlabel</span> <span class="op">&lt;</span> <span class="fl">10</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"0"</span>, <span class="va">minlabel</span><span class="op">)</span>, <span class="va">minlabel</span><span class="op">)</span>,</span>
<span>         seclabel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">clock.seconds</span> <span class="op">&lt;</span> <span class="fl">10</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"0"</span>, <span class="va">clock.seconds</span><span class="op">)</span>, <span class="va">clock.seconds</span><span class="op">)</span>,</span>
<span>         time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">minlabel</span>, <span class="st">":"</span>, <span class="va">seclabel</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
<p>Now that our data matches <code>nflfastR</code>, we can start to copy
Lee Sharpe’s code and the bulk of the remaining code is his with a few
minor adjustments to the plot, the overtime logic, and the labels. First
we filter out plays that don’t have a win percentage and fix the win
probability so that it is always the probability of the away team
winning.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">base_wp_data</span> <span class="op">&lt;-</span> <span class="va">game_pbp</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">wp</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>s <span class="op">=</span> <span class="va">game_seconds_remaining</span>,</span>
<span>         wp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">posteam</span> <span class="op">==</span> <span class="va">away_team</span>, <span class="va">wp</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">wp</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Then we fix the plays without a wpa.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># fix if play other than last is NA</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">r</span> <span class="kw">in</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">base_wp_data</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">base_wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">base_wp_data</span><span class="op">$</span><span class="va">wpa</span><span class="op">[</span><span class="va">r</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="va">target_wp</span> <span class="op">&lt;-</span> <span class="va">base_wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="va">base_wp_data</span><span class="op">$</span><span class="va">wpa</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">target_wp</span> <span class="op">-</span> <span class="va">base_wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># fix if last play is NA</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">base_wp_data</span><span class="op">$</span><span class="va">wpa</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">base_wp_data</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">base_wp_data</span><span class="op">)</span></span>
<span>  <span class="va">move_to</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">game</span><span class="op">$</span><span class="va">result</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">game</span><span class="op">$</span><span class="va">result</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">delta</span> <span class="op">&lt;-</span> <span class="va">move_to</span> <span class="op">-</span> <span class="va">base_wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">]</span></span>
<span>  <span class="va">base_wp_data</span><span class="op">$</span><span class="va">wpa</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">base_wp_data</span><span class="op">$</span><span class="va">posteam</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">==</span> <span class="va">game</span><span class="op">$</span><span class="va">away_team</span>, <span class="va">delta</span>, <span class="op">-</span><span class="va">delta</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now we create the labels. This generates labels for any play that had
a change in the winning percentage of more than 10 percentage points.
We’ll also simplify our data frame by only selecting the relevant
columns for our plots.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">abs_wpa</span> <span class="op">&lt;-</span> <span class="fl">0.07</span></span>
<span></span>
<span><span class="va">wp_data</span> <span class="op">&lt;-</span> <span class="va">base_wp_data</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    helped<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">wpa</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="va">posteam</span>, <span class="va">defteam</span><span class="op">)</span>,</span>
<span>    text <span class="op">=</span> </span>
<span>      <span class="fu">case_when</span><span class="op">(</span></span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Kickoff"</span> <span class="op">&amp;</span> </span>
<span>         <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">kickoff_returner_player_name</span><span class="op">)</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{kickoff_returner_player_name} KR"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Rush"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{rusher_player_name} Rush"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Pass Reception"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{receiver_player_name} Catch"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Sack"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{sack_player_name} SACK"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Punt"</span> <span class="op">~</span> <span class="st">""</span>,<span class="co">#glue("{punt_returner_player_name} PR"),</span></span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Pass Incompletion"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{passer_player_name} Incomplete"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Fumble Recovery (Opponent)"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{posteam} FUMBLE"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Penalty"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"PENALTY"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Field Goal Missed"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{posteam} FG MISS"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Passing Touchdown"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{receiver_player_name} TD"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Rushing Touchdown"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{rusher_player_name} TD"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Field Goal Good"</span> <span class="op">&amp;</span></span>
<span>         <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">fg_kicker_player_name</span><span class="op">)</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{fg_kicker_player_name} FG GOOD"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Field Goal Good"</span> <span class="op">&amp;</span></span>
<span>         <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">fg_kicker_player_name</span><span class="op">)</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{posteam} FG GOOD"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Timeout"</span> <span class="op">~</span> <span class="st">""</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Interception Return"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{interception_player_name} INT"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Fumble Recovery (Own)"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{rusher_player_name} Rush"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Blocked Field Goal"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{posteam} FG BLK"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Kickoff Return (Offense)"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{kickoff_returner_player_name} KR"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Blocked Punt"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{defteam} PUNT BLK"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Interception Return Touchdown"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{interception_player_name} DEF TD"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Kickoff Return Touchdown"</span> <span class="op">&amp;</span> </span>
<span>         <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">kickoff_returner_player_name</span><span class="op">)</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{kickoff_returner_player_name} KR TD"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Punt Touchdown"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{punt_returner_player_name} PR TD"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Fumble Recovery (Opponent) Touchdown"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{defteam} FUMBLE TD"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Fumble Return Touchdown"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{defteam} FUMBLE TD"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Safety"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"SAFETY"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Punt Touchdown"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{posteam} PR FUMBLE TD"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Kickoff Touchdown"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{posteam} KR FUMBLE TD"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Punt Return Touchdown"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{punt_returner_player_name} PR TD"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Uncategorized"</span> <span class="op">~</span> <span class="st">""</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Blocked Punt Touchdown"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{defteam} PUNT BLK TD"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"placeholder"</span> <span class="op">~</span> <span class="st">""</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Missed Field Goal Return"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{posteam} FG MISS"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Missed Field Goal Return Touchdown"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{defteam} FGR TD"</span><span class="op">)</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Defensive 2pt Conversion"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{defteam} DEF 2PT"</span><span class="op">)</span>,</span>
<span>       <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">""</span><span class="op">)</span>,</span>
<span>    text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">text</span> <span class="op">==</span> <span class="st">""</span>,<span class="st">""</span>, <span class="fu">glue</span><span class="op">(</span><span class="st">"{text}\n{helped} +{abs(round(100*wpa))}%"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    away_score <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">posteam</span> <span class="op">==</span> <span class="va">away_team</span>, <span class="va">posteam_score</span>, <span class="va">defteam_score</span><span class="op">)</span>,</span>
<span>    home_score <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">posteam</span> <span class="op">==</span> <span class="va">away_team</span>, <span class="va">defteam_score</span>, <span class="va">posteam_score</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">play_id</span>, <span class="va">qtr</span>, <span class="va">time</span>, <span class="va">s</span>, <span class="va">wp</span>, <span class="va">wpa</span>, <span class="va">posteam</span>, <span class="va">away_score</span>, <span class="va">home_score</span>, <span class="va">text</span><span class="op">)</span></span></code></pre></div>
<p>This is where the real magic happens. Sharpe’s code will iterate over
the labels and try to determine valid locations for each one.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># points for plotting</span></span>
<span><span class="va">x_max</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">x_lab_min</span> <span class="op">&lt;-</span> <span class="fl">3600</span> <span class="op">-</span> <span class="fl">250</span></span>
<span><span class="va">x_lab_max</span> <span class="op">&lt;-</span> <span class="va">x_max</span> <span class="op">+</span> <span class="fl">250</span></span>
<span><span class="va">x_score</span> <span class="op">&lt;-</span> <span class="fl">320</span> <span class="op">-</span> <span class="va">x_max</span></span>
<span><span class="co"># determine the location of the label</span></span>
<span><span class="va">wp_data</span><span class="op">$</span><span class="va">x_text</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">wp_data</span><span class="op">$</span><span class="va">y_text</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">wp_data</span> <span class="op">&lt;-</span> <span class="va">wp_data</span> <span class="op">%&gt;%</span> <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">seq_fix</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">start</span>, <span class="va">end</span>, <span class="va">move</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">move</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">&amp;&amp;</span> <span class="va">start</span> <span class="op">&lt;</span> <span class="va">end</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">end</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">move</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">&amp;&amp;</span> <span class="va">start</span> <span class="op">&gt;</span> <span class="va">end</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">end</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">start</span>, <span class="va">end</span>, <span class="va">move</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">r</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">text</span> <span class="op">!=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="co"># ordered list of spots this label could go</span></span>
<span>  <span class="va">y_side</span> <span class="op">&lt;-</span> <span class="va">wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">&gt;=</span> <span class="fl">0.5</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">y_side</span><span class="op">)</span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="va">y_spots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">seq_fix</span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">-</span> <span class="fl">0.1</span>, <span class="fl">0.05</span>, <span class="op">-</span><span class="fl">0.1</span><span class="op">)</span>, <span class="fu">seq_fix</span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">+</span> <span class="fl">0.1</span>, <span class="fl">0.95</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">y_spots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">seq_fix</span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">+</span> <span class="fl">0.1</span>, <span class="fl">0.95</span>, <span class="fl">0.1</span><span class="op">)</span>, <span class="fu">seq_fix</span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">-</span> <span class="fl">0.1</span>, <span class="fl">0.05</span>, <span class="op">-</span><span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># iterate, see if this spot is valid</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y_spots</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="va">valid</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">wp_data</span> <span class="op">%&gt;%</span> </span>
<span>             <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">y_spots</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="fl">0.1</span> <span class="op">&lt;</span> <span class="va">wp</span> <span class="op">&amp;</span> <span class="va">wp</span> <span class="op">&lt;</span> <span class="va">y_spots</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="fl">0.1</span> <span class="op">&amp;</span></span>
<span>                    <span class="va">wp_data</span><span class="op">$</span><span class="va">s</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">-</span> <span class="fl">300</span> <span class="op">&lt;</span> <span class="va">s</span> <span class="op">&amp;</span> <span class="va">s</span> <span class="op">&lt;</span> <span class="va">wp_data</span><span class="op">$</span><span class="va">s</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">+</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="op">{</span></span>
<span>      <span class="co"># too close to the WP line</span></span>
<span>      <span class="va">valid</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">wp_data</span> <span class="op">%&gt;%</span> </span>
<span>             <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">y_spots</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="fl">0.1</span> <span class="op">&lt;</span> <span class="va">y_text</span> <span class="op">&amp;</span> <span class="va">y_text</span> <span class="op">&lt;</span> <span class="va">y_spots</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="fl">0.1</span> <span class="op">&amp;</span></span>
<span>                    <span class="va">wp_data</span><span class="op">$</span><span class="va">s</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">-</span> <span class="fl">600</span> <span class="op">&lt;</span> <span class="va">x_text</span> <span class="op">&amp;</span> <span class="va">x_text</span> <span class="op">&lt;</span> <span class="va">wp_data</span><span class="op">$</span><span class="va">s</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">+</span> <span class="fl">600</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="op">{</span></span>
<span>      <span class="co"># too close to another label</span></span>
<span>      <span class="va">valid</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">valid</span><span class="op">)</span></span>
<span>    <span class="op">{</span></span>
<span>      <span class="co"># we found a spot for it, store and break loop</span></span>
<span>      <span class="va">wp_data</span><span class="op">$</span><span class="va">x_text</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">wp_data</span><span class="op">$</span><span class="va">s</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> </span>
<span>      <span class="va">wp_data</span><span class="op">$</span><span class="va">y_text</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">y_spots</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>      <span class="kw">break</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># try x_spots?</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">valid</span><span class="op">)</span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="va">x_side</span> <span class="op">&lt;-</span> <span class="va">wp_data</span><span class="op">$</span><span class="va">s</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">&gt;=</span> <span class="fl">1800</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">x_side</span><span class="op">)</span></span>
<span>    <span class="op">{</span></span>
<span>      <span class="va">x_spots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">seq_fix</span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">s</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">-</span> <span class="fl">400</span>, <span class="va">x_lab_max</span>, <span class="op">-</span><span class="fl">200</span><span class="op">)</span>,</span>
<span>                   <span class="fu">seq_fix</span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">s</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">+</span> <span class="fl">400</span>, <span class="va">x_lab_min</span>, <span class="fl">200</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">x_spots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">seq_fix</span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">s</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">+</span> <span class="fl">400</span>, <span class="va">x_lab_min</span>, <span class="fl">200</span><span class="op">)</span>,</span>
<span>                   <span class="fu">seq_fix</span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">s</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">-</span> <span class="fl">400</span>, <span class="va">x_lab_max</span>, <span class="op">-</span><span class="fl">200</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x_spots</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">{</span></span>
<span>      <span class="va">valid</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">wp_data</span> <span class="op">%&gt;%</span> </span>
<span>               <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">-</span> <span class="fl">0.1</span> <span class="op">&lt;</span> <span class="va">wp</span> <span class="op">&amp;</span> <span class="va">wp</span> <span class="op">&lt;</span> <span class="va">wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">+</span> <span class="fl">0.1</span> <span class="op">&amp;</span></span>
<span>                      <span class="va">x_spots</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="fl">300</span> <span class="op">&lt;</span> <span class="va">s</span> <span class="op">&amp;</span> <span class="va">s</span> <span class="op">&lt;</span> <span class="va">x_spots</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span>      <span class="op">{</span></span>
<span>        <span class="co"># too close to the WP line</span></span>
<span>        <span class="va">valid</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">wp_data</span> <span class="op">%&gt;%</span> </span>
<span>               <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">-</span> <span class="fl">0.1</span> <span class="op">&lt;</span> <span class="va">y_text</span> <span class="op">&amp;</span> <span class="va">y_text</span> <span class="op">&lt;</span> <span class="va">wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">+</span> <span class="fl">0.1</span> <span class="op">&amp;</span></span>
<span>                      <span class="va">x_spots</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="fl">600</span> <span class="op">&lt;</span> <span class="va">x_text</span> <span class="op">&amp;</span> <span class="va">x_text</span> <span class="op">&lt;</span> <span class="va">x_spots</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="fl">600</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span>      <span class="op">{</span></span>
<span>        <span class="co"># too close to another label</span></span>
<span>        <span class="va">valid</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">valid</span><span class="op">)</span></span>
<span>      <span class="op">{</span></span>
<span>        <span class="co"># we found a spot for it, stop loop</span></span>
<span>        <span class="va">wp_data</span><span class="op">$</span><span class="va">x_text</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x_spots</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>        <span class="va">wp_data</span><span class="op">$</span><span class="va">y_text</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">]</span></span>
<span>        <span class="kw">break</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># warn about the labels not placed</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">valid</span><span class="op">)</span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="fu">glue</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"No room for ({wp_data$s[r]},{round(wp_data$wp[r], 3)}):"</span>,</span>
<span>                       <span class="st">"{gsub('\n',' ',wp_data$text[r])}"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Finally, we create two new rows to our data frame for the start and
end of the game, filter out any other weirdness, and arrange our data
frame by the order of the plays.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># add on WP boundaries</span></span>
<span><span class="va">first_row</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>play_id <span class="op">=</span> <span class="fl">0</span>, qtr <span class="op">=</span> <span class="fl">1</span>, time <span class="op">=</span> <span class="st">"15:00"</span>, s <span class="op">=</span> <span class="fl">3600</span>,</span>
<span>                        wp <span class="op">=</span> <span class="fl">0.5</span>, wpa <span class="op">=</span> <span class="cn">NA</span>, text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span>,</span>
<span>                        x_text <span class="op">=</span> <span class="fl">3600</span>, y_text <span class="op">=</span> <span class="fl">0.5</span>, away_score <span class="op">=</span> <span class="fl">0</span>, home_score <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                        stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">last_row</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>play_id <span class="op">=</span> <span class="fl">999999</span>, qtr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">qtr</span><span class="op">)</span>, s <span class="op">=</span> <span class="va">x_max</span> <span class="op">-</span> <span class="fl">1</span>,</span>
<span>                       time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">qtr</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">5</span>, <span class="st">"FINAL\nOT"</span>, <span class="st">"FINAL"</span><span class="op">)</span>,</span>
<span>                       wp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">game</span><span class="op">$</span><span class="va">result</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">game</span><span class="op">$</span><span class="va">result</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                       wpa <span class="op">=</span> <span class="cn">NA</span>, text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span>, x_text <span class="op">=</span> <span class="va">x_max</span>, y_text <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>                       away_score <span class="op">=</span> <span class="va">game</span><span class="op">$</span><span class="va">away_score</span>, home_score <span class="op">=</span> <span class="va">game</span><span class="op">$</span><span class="va">home_score</span>,</span>
<span>                       stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">wp_data</span> <span class="op">&lt;-</span> <span class="va">wp_data</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">posteam</span> <span class="op">!=</span> <span class="st">""</span>,</span>
<span>         <span class="va">wpa</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">bind_rows</span><span class="op">(</span><span class="va">first_row</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">bind_rows</span><span class="op">(</span><span class="va">last_row</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="va">play_id</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="plotting">Plotting<a class="anchor" aria-label="anchor" href="#plotting"></a>
</h2>
<p>Now we’re ready for plotting. The <code>draw_frame()</code> function
will draw our win probability plot for any given number of seconds
remaining in the game. This is where you can make any changes to the
plot that you would like.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">draw_frame</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n_sec</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># frame data</span></span>
<span>  <span class="va">frm_data</span> <span class="op">&lt;-</span> <span class="va">wp_data</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">s</span> <span class="op">&gt;=</span> <span class="va">n_sec</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># output quarter changes</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">frm_data</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">qtr</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">qtr</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu">glue</span><span class="op">(</span><span class="st">"Plotting pbp in quarter {max(frm_data$qtr)}"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># plot</span></span>
<span>  <span class="va">frm_plot</span> <span class="op">&lt;-</span> <span class="va">frm_data</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">s</span>, y <span class="op">=</span> <span class="va">wp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3600</span>, <span class="va">x_max</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"#5555AA"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_segment</span><span class="op">(</span>x <span class="op">=</span> <span class="op">-</span><span class="fl">3600</span>, xend <span class="op">=</span> <span class="op">-</span><span class="va">x_max</span>, y <span class="op">=</span> <span class="fl">0.5</span>, yend <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_image</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_score</span>, y <span class="op">=</span> <span class="fl">0.82</span>, image <span class="op">=</span> <span class="va">game</span><span class="op">$</span><span class="va">away_logo</span>, size <span class="op">=</span> <span class="fl">0.08</span>, asp <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_image</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_score</span>, y <span class="op">=</span> <span class="fl">0.18</span>, image <span class="op">=</span> <span class="va">game</span><span class="op">$</span><span class="va">home_logo</span>, size <span class="op">=</span> <span class="fl">0.08</span>, asp <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">..y..</span> <span class="op">&lt;</span> <span class="fl">.5</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">game</span><span class="op">$</span><span class="va">away_color</span>, <span class="va">game</span><span class="op">$</span><span class="va">home_color</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_x_continuous</span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"reverse"</span>,</span>
<span>                       minor_breaks <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                       labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"KICK\nOFF"</span>, <span class="st">"END\nQ1"</span>, <span class="st">"HALF\nTIME"</span>, <span class="st">"END\nQ3"</span>, <span class="st">"FINAL"</span><span class="op">)</span>,</span>
<span>                       breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">3600</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">900</span><span class="op">)</span>,</span>
<span>                       limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3700</span>, <span class="va">x_max</span> <span class="op">-</span> <span class="fl">490</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">glue</span><span class="op">(</span><span class="st">"{game$home_abr} 100%"</span><span class="op">)</span>,</span>
<span>                                  <span class="fu">glue</span><span class="op">(</span><span class="st">"{game$home_abr} 75%"</span><span class="op">)</span>,</span>
<span>                                  <span class="st">"50%"</span>,</span>
<span>                                  <span class="fu">glue</span><span class="op">(</span><span class="st">"{game$away_abr} 75%"</span><span class="op">)</span>,</span>
<span>                                  <span class="fu">glue</span><span class="op">(</span><span class="st">"{game$away_abr} 100%"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                       breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                       limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">coord_cartesian</span><span class="op">(</span>clip <span class="op">=</span> <span class="st">"off"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ylab</span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"Win Probability Chart: {game$season} Week {game$wk} {game$away_team} @ {game$home_team}"</span><span class="op">)</span>,</span>
<span>         caption <span class="op">=</span> <span class="st">"Data from cfbfastR, Visualization by @LeeSharpeNFL, Adapted for CFB by @JaredDLee"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># score display </span></span>
<span>  <span class="va">away_score</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">frm_data</span><span class="op">$</span><span class="va">away_score</span><span class="op">)</span></span>
<span>  <span class="va">home_score</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">frm_data</span><span class="op">$</span><span class="va">home_score</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># clock display</span></span>
<span>  <span class="va">qtr</span> <span class="op">&lt;-</span> <span class="fu">case_when</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">frm_data</span><span class="op">$</span><span class="va">qtr</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"1st"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">frm_data</span><span class="op">$</span><span class="va">qtr</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"2nd"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">frm_data</span><span class="op">$</span><span class="va">qtr</span><span class="op">)</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">~</span> <span class="st">"3rd"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">frm_data</span><span class="op">$</span><span class="va">qtr</span><span class="op">)</span> <span class="op">==</span> <span class="fl">4</span> <span class="op">~</span> <span class="st">"4th"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">frm_data</span><span class="op">$</span><span class="va">qtr</span><span class="op">)</span> <span class="op">==</span> <span class="fl">5</span> <span class="op">~</span> <span class="st">"OT"</span>,</span>
<span>    <span class="cn">TRUE</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">frm_data</span><span class="op">$</span><span class="va">qtr</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">clock</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">frm_data</span><span class="op">$</span><span class="va">time</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">clock</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">clock</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">==</span> <span class="st">"0"</span>, <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">clock</span>, <span class="fl">2</span>, <span class="fl">100</span><span class="op">)</span>, <span class="va">clock</span><span class="op">)</span></span>
<span>  <span class="va">clock</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">qtr</span>, <span class="st">"\n"</span>, <span class="va">clock</span><span class="op">)</span></span>
<span>  <span class="va">clock</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"FINAL"</span>, <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">frm_data</span><span class="op">$</span><span class="va">time</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">frm_data</span><span class="op">$</span><span class="va">time</span>, <span class="fl">1</span><span class="op">)</span>, <span class="va">clock</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># add score and clock to plot</span></span>
<span>  <span class="va">frm_plot</span> <span class="op">&lt;-</span> <span class="va">frm_plot</span> <span class="op">+</span> </span>
<span>    <span class="fu">annotate</span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">*</span><span class="va">x_score</span>, y <span class="op">=</span> <span class="fl">0.71</span>, label <span class="op">=</span> <span class="va">away_score</span>, color <span class="op">=</span> <span class="va">game</span><span class="op">$</span><span class="va">away_color</span>, size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">annotate</span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">*</span><span class="va">x_score</span>, y <span class="op">=</span> <span class="fl">0.29</span>, label <span class="op">=</span> <span class="va">home_score</span>, color <span class="op">=</span> <span class="va">game</span><span class="op">$</span><span class="va">home_color</span>, size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">annotate</span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">*</span><span class="va">x_score</span>, y <span class="op">=</span> <span class="fl">0.50</span>, label <span class="op">=</span> <span class="va">clock</span>, color <span class="op">=</span> <span class="st">"#000000"</span>, size <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># label key moments</span></span>
<span>  <span class="va">frm_labels</span> <span class="op">&lt;-</span> <span class="va">frm_data</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">text</span> <span class="op">!=</span> <span class="st">""</span><span class="op">)</span></span>
<span>  <span class="va">frm_plot</span> <span class="op">&lt;-</span> <span class="va">frm_plot</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_point</span><span class="op">(</span><span class="va">frm_labels</span>, mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">s</span>, y <span class="op">=</span> <span class="va">wp</span><span class="op">)</span>,</span>
<span>               color <span class="op">=</span> <span class="st">"#000000"</span>, size <span class="op">=</span> <span class="fl">2</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_segment</span><span class="op">(</span><span class="va">frm_labels</span>, mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_text</span>, xend <span class="op">=</span> <span class="va">s</span>, y <span class="op">=</span> <span class="va">y_text</span>, yend <span class="op">=</span> <span class="va">wp</span><span class="op">)</span>,</span>
<span>                 linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"#000000"</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_label</span><span class="op">(</span><span class="va">frm_labels</span>, mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_text</span>, y <span class="op">=</span> <span class="va">y_text</span>, label <span class="op">=</span> <span class="va">text</span><span class="op">)</span>,</span>
<span>               size <span class="op">=</span> <span class="fl">3</span>, color <span class="op">=</span> <span class="st">"#000000"</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># plot the frame</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">frm_plot</span>, width <span class="op">=</span> <span class="fl">12.5</span>, height <span class="op">=</span> <span class="fl">6.47</span>, dpi <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Let’s test our function to make sure the plot looks like how we want
it by running our function with 6 minutes left in the game.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">draw_frame</span><span class="op">(</span><span class="fl">360</span><span class="op">)</span></span></code></pre></div>
<p><img src="animated-wp-plotting_files/figure-html/draw_test-1.png" width="700"></p>
<p>Looks great, so next we create the <code>draw_game()</code> function
which will draw every frame for our GIF.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">draw_game</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">s</span>, <span class="kw">function</span><span class="op">(</span><span class="va">n_sec</span><span class="op">)</span></span>
<span>  <span class="op">{</span> </span>
<span>    <span class="fu">draw_frame</span><span class="op">(</span><span class="va">n_sec</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"Plotting frames for pause"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="fl">40</span>, <span class="fu">draw_frame</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">s</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"Assembling plots into a GIF"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="animating">Animating<a class="anchor" aria-label="anchor" href="#animating"></a>
</h2>
<p>Finally, we run our <code>draw_game()</code> function inside of
<code>saveGIF()</code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co"># saveGIF(draw_game(), interval = 0.1, movie.name = "animated_wp.gif")</span></span></code></pre></div>
<div class="figure">
<img src="https://github.com/sportsdataverse/cfbfastR/blob/main/man/figures/animated_wp.gif?raw=true" alt=""><p class="caption">Result</p>
</div>
<p>This process takes awhile, about 3 minutes on my computer. We can
also re-size our GIF using the <code>ani.width</code>,
<code>ani.height</code> and <code>ani.res</code> parameters. I like to
make my plots wider and at higher resolution, but be careful, this will
drastically increase the rendering time and the file size.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># saveGIF(draw_game(), interval = 0.1, movie.name = 'animated_wp_wide.gif',</span></span>
<span><span class="co">#         ani.width = 800, ani.height = 500, ani.res = 110)</span></span></code></pre></div>
<div class="figure">
<img src="https://kazink36.github.io/images/animated_wp_ex_wide.gif" alt=""><p class="caption">Result</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://twitter.com/saiemgilani" class="external-link">Saiem Gilani</a>, <a href="https://twitter.com/akeaswaran" class="external-link">Akshay Easwaran</a>, <a href="https://twitter.com/JaredDLee" class="external-link">Jared Lee</a>, <a href="https://twitter.com/arbitanalytics" class="external-link">Eric Hess</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
